<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Requests - Company.AI</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/animations.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f172a 100%);
            background-attachment: fixed;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(236, 72, 153, 0.05) 0%, transparent 50%);
            animation: gradientShift 15s ease infinite;
            z-index: 0;
        }

        .main-wrapper {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .premium-sidebar {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(59, 130, 246, 0.2);
            padding: 32px 24px;
            position: relative;
            overflow: hidden;
        }

        .premium-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.05) 0%, transparent 100%);
            z-index: 0;
        }

        .premium-sidebar>* {
            position: relative;
            z-index: 1;
        }

        .logo-section {
            margin-bottom: 48px;
            text-align: center;
        }

        .logo-text {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            background-size: 200% 200%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 4s ease infinite;
            letter-spacing: -0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            margin-bottom: 8px;
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            transform: translateX(8px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            color: white;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .nav-item i {
            width: 20px;
            height: 20px;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #10b981;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s ease-in-out infinite;
        }

        .premium-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeInDown 0.6s ease-out 0.2s forwards;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, rgba(255, 255, 255, 0.7) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .icon-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .icon-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }

        .new-request-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        .new-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(59, 130, 246, 0.5);
        }

        .new-request-btn i {
            width: 18px;
            height: 18px;
        }

        /* Leave Cards Grid */
        .leaves-container {
            display: grid;
            gap: 20px;
        }

        .leave-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.6));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out forwards;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 24px;
            align-items: center;
        }

        .leave-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #3b82f6, #8b5cf6);
        }

        .leave-card:hover {
            transform: translateX(8px);
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .leave-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .leave-icon i {
            width: 32px;
            height: 32px;
            color: #3b82f6;
        }

        .leave-details {
            flex: 1;
        }

        .leave-type {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .leave-dates {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .leave-dates i {
            width: 16px;
            height: 16px;
            color: #3b82f6;
        }

        .leave-reason {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
            max-width: 600px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .leave-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        .status-badge {
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-badge.approved {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-badge.ai-approved {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .status-badge.rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .leave-submitted {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.4);
        }

        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out 0.3s forwards;
        }

        .filter-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tab:hover {
            background: rgba(59, 130, 246, 0.1);
            color: white;
        }

        .filter-tab.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3));
            border-color: rgba(59, 130, 246, 0.5);
            color: white;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 40px;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.4s forwards;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
        }

        .empty-icon i {
            width: 40px;
            height: 40px;
            color: #3b82f6;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 12px;
        }

        .empty-desc {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .user-profile-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 20px 8px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-profile-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-2px);
        }

        .user-avatar-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
        }

        .user-name-text {
            color: white;
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* Priority Badge Styles */
        .priority-eligible {
            border: 1px solid rgba(245, 158, 11, 0.5) !important;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(15, 15, 35, 0.95) 100%) !important;
        }

        .priority-badge-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .priority-badge-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #f59e0b;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .priority-badge-header i {
            width: 16px;
            height: 16px;
        }

        .priority-badge-options {
            display: flex;
            gap: 10px;
        }

        .priority-btn {
            flex: 1;
            padding: 10px 16px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .priority-btn.red {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .priority-btn.red:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            transform: scale(1.02);
        }

        .priority-btn.yellow {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .priority-btn.yellow:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
            transform: scale(1.02);
        }

        .priority-set-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            animation: pulse 2s ease-in-out infinite;
        }

        .priority-set-badge.red {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.4);
        }

        .priority-set-badge.yellow {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.4);
        }

        .priority-info {
            display: flex;
            align-items: center;
            gap: 6px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
            margin-top: 4px;
        }

        .priority-info i {
            width: 12px;
            height: 12px;
        }

        .eligibility-timer {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 8px;
        }

        .eligibility-timer i {
            width: 14px;
            height: 14px;
        }

        /* Priority Modal */
        .priority-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .priority-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);
            border-radius: 24px;
            width: 90%;
            max-width: 480px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .priority-modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .priority-modal-header h3 {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .priority-modal-header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .priority-option {
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .priority-option.red-option {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .priority-option.red-option:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            transform: scale(1.02);
        }

        .priority-option.yellow-option {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }

        .priority-option.yellow-option:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: #f59e0b;
            transform: scale(1.02);
        }

        .priority-option-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .priority-option-icon {
            font-size: 2rem;
        }

        .priority-option-title {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .priority-option-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .priority-modal-footer {
            margin-top: 16px;
            text-align: center;
        }

        .cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 32px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        .cancel-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body>
    <div class="main-wrapper">
        <!-- Premium Sidebar -->
        <aside class="premium-sidebar animate-fade-in-left">
            <div class="logo-section">
                <h1 class="logo-text animate-scale-in">Company.AI</h1>
                <div class="ai-status" style="justify-content: center; margin-top: 12px;">
                    <div class="status-dot"></div>
                    <span>Online â€¢ Neural Core v2.1</span>
                </div>
            </div>

            <nav style="display: flex; flex-direction: column; gap: 8px;">
                <a href="dashboard.html" class="nav-item animate-fade-in-left delay-100">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="profile.html" class="nav-item animate-fade-in-left delay-200">
                    <i data-lucide="user"></i>
                    <span>My Profile</span>
                </a>
                <a href="leave-request.html" class="nav-item animate-fade-in-left delay-300">
                    <i data-lucide="file-plus"></i>
                    <span>Request Leave</span>
                </a>
                <a href="leaves.html" class="nav-item active animate-fade-in-left delay-400">
                    <i data-lucide="file-text"></i>
                    <span>My Leaves</span>
                </a>
                <a href="attendance" class="nav-item animate-fade-in-left delay-500">
                    <i data-lucide="calendar"></i>
                    <span>Attendance</span>
                </a>
                <a href="../my-payroll.html" class="nav-item animate-fade-in-left delay-600">
                    <i data-lucide="wallet"></i>
                    <span>Payroll</span>
                </a>
            </nav>

            <div style="margin-top: auto; padding-top: 32px;">
                <button id="logoutBtn" class="nav-item"
                    style="width: 100%; color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);">
                    <i data-lucide="log-out"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main style="padding: 40px; max-width: 1400px;">
            <!-- Premium Header -->
            <header class="premium-header">
                <div>
                    <h1 class="page-title">My Leave Requests</h1>
                    <p style="color: rgba(255,255,255,0.5); margin-top: 8px; font-size: 1rem;">Track and manage all your
                        leave applications</p>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="UI.showToast('No new notifications', 'info')">
                        <i data-lucide="bell"></i>
                    </button>
                    <button class="new-request-btn ripple" onclick="window.location.href='leave-request.html'">
                        <i data-lucide="plus"></i>
                        New Request
                    </button>
                    <div class="user-profile-btn" onclick="window.location.href='profile.html'">
                        <div class="user-avatar-circle" id="userAvatar">U</div>
                        <span class="user-name-text" id="userName">User</span>
                    </div>
                </div>
            </header>

            <!-- Filter Tabs -->
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterLeaves('all')">All Requests</button>
                <button class="filter-tab" onclick="filterLeaves('pending')">Pending</button>
                <button class="filter-tab" onclick="filterLeaves('approved')">Approved</button>
                <button class="filter-tab" onclick="filterLeaves('rejected')">Rejected</button>
            </div>

            <!-- Leaves Container -->
            <div class="leaves-container" id="leavesContainer">
                <div class="empty-state">
                    <div class="loading-spinner"
                        style="margin: 0 auto 24px; width: 50px; height: 50px; border-width: 4px;"></div>
                    <div class="empty-title">Loading your leave requests...</div>
                </div>
            </div>
        </main>
    </div>

    <script src="../../assets/js/api.js"></script>
    <script>
        lucide.createIcons();

        let allLeaves = [];
        let priorityEligibility = {};
        let currentFilter = 'all';

        async function init() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '../../index.html';
                return;
            }
            const user = JSON.parse(userStr);
            document.getElementById('userName').innerText = user.name;
            document.getElementById('userAvatar').innerText = user.name.charAt(0).toUpperCase();

            await loadLeaves();
            
            // Refresh priority data every minute
            setInterval(loadPriorityStatus, 60000);
        }

        async function loadLeaves() {
            try {
                const response = await API.get('/leaves/my-leaves');
                allLeaves = response.leaves || response || [];
                await loadPriorityStatus();
                renderLeaves();
            } catch (e) {
                console.error('Failed to load leaves:', e);
                document.getElementById('leavesContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i data-lucide="alert-circle"></i>
                        </div>
                        <div class="empty-title">Failed to load leave requests</div>
                        <div class="empty-desc">Please try again later</div>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        async function loadPriorityStatus() {
            // Load priority eligibility for all pending leaves
            const pendingLeaves = allLeaves.filter(l => l.status.toLowerCase() === 'pending');
            
            for (const leave of pendingLeaves) {
                try {
                    const response = await API.get(`/ai-leave-mode/priority/eligible/${leave.request_id}`);
                    priorityEligibility[leave.request_id] = response;
                } catch (e) {
                    console.log(`Could not check priority for ${leave.request_id}:`, e);
                    priorityEligibility[leave.request_id] = { can_set_priority: false };
                }
            }
        }

        function getPriorityUI(leave) {
            const eligibility = priorityEligibility[leave.request_id];
            
            if (!eligibility) return '';
            
            // If priority already set
            if (eligibility.current_priority) {
                const level = eligibility.current_priority;
                const emoji = level === 'red' ? 'ðŸ”´' : 'ðŸŸ¡';
                const label = level === 'red' ? 'EMERGENCY' : 'PRIORITY';
                const escalationInfo = level === 'red' ? getEscalationTimeLeft(eligibility) : 'HR will be reminded periodically';
                
                return `
                    <div class="priority-badge-container">
                        <div class="priority-set-badge ${level}">
                            <span>${emoji}</span>
                            <span>${label} Badge Set</span>
                        </div>
                        <div class="priority-info">
                            <i data-lucide="info"></i>
                            <span>${escalationInfo}</span>
                        </div>
                    </div>
                `;
            }
            
            // If eligible to set priority
            if (eligibility.can_set_priority) {
                return `
                    <div class="priority-badge-container">
                        <div class="priority-badge-header">
                            <i data-lucide="alert-triangle"></i>
                            <span>HR hasn't responded yet. Set a priority badge:</span>
                        </div>
                        <div class="priority-badge-options">
                            <button class="priority-btn red" onclick="event.stopPropagation(); showPriorityModal('${leave.request_id}')">
                                ðŸ”´ Emergency
                            </button>
                            <button class="priority-btn yellow" onclick="event.stopPropagation(); showPriorityModal('${leave.request_id}')">
                                ðŸŸ¡ Priority
                            </button>
                        </div>
                        <div class="priority-info">
                            <i data-lucide="info"></i>
                            <span>Red: Emergency (auto-escalates in 24hr). Yellow: Priority reminder to HR.</span>
                        </div>
                    </div>
                `;
            }
            
            // If waiting for eligibility
            if (eligibility.time_until_eligible) {
                const hours = Math.floor(eligibility.time_until_eligible / 3600);
                const minutes = Math.floor((eligibility.time_until_eligible % 3600) / 60);
                return `
                    <div class="eligibility-timer">
                        <i data-lucide="clock"></i>
                        <span>Priority badge available in ${hours}h ${minutes}m if HR doesn't respond</span>
                    </div>
                `;
            }
            
            return '';
        }

        function getEscalationTimeLeft(eligibility) {
            if (!eligibility.priority_set_at) return 'Auto-escalation pending';
            
            const setAt = new Date(eligibility.priority_set_at);
            const escalationTime = new Date(setAt.getTime() + (24 * 60 * 60 * 1000)); // 24 hours
            const now = new Date();
            const diff = escalationTime - now;
            
            if (diff <= 0) return 'Auto-escalation processing';
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            return `Will auto-process in ${hours}h ${minutes}m if HR doesn't respond`;
        }

        function showPriorityModal(requestId) {
            const modal = document.createElement('div');
            modal.className = 'priority-modal';
            modal.id = 'priorityModal';
            modal.innerHTML = `
                <div class="priority-modal-content">
                    <div class="priority-modal-header">
                        <h3>ðŸš¨ Set Priority Badge</h3>
                        <p>Choose a priority level for your leave request</p>
                    </div>
                    
                    <div class="priority-option red-option" onclick="setPriority('${requestId}', 'red')">
                        <div class="priority-option-header">
                            <span class="priority-option-icon">ðŸ”´</span>
                            <span class="priority-option-title">Emergency Response Needed</span>
                        </div>
                        <div class="priority-option-desc">
                            For urgent situations requiring immediate attention. If HR doesn't respond within 24 hours, 
                            the system will automatically evaluate your request and either approve it (if all rules match) 
                            or escalate to your manager.
                        </div>
                    </div>
                    
                    <div class="priority-option yellow-option" onclick="setPriority('${requestId}', 'yellow')">
                        <div class="priority-option-header">
                            <span class="priority-option-icon">ðŸŸ¡</span>
                            <span class="priority-option-title">Priority - Non-Emergency</span>
                        </div>
                        <div class="priority-option-desc">
                            For important but non-urgent requests. HR will receive periodic reminders about your 
                            request. This does not trigger automatic approval or escalation.
                        </div>
                    </div>
                    
                    <div class="priority-modal-footer">
                        <button class="cancel-btn" onclick="closePriorityModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closePriorityModal() {
            const modal = document.getElementById('priorityModal');
            if (modal) modal.remove();
        }

        async function setPriority(requestId, level) {
            closePriorityModal();
            
            try {
                const response = await API.post('/ai-leave-mode/priority/set', {
                    request_id: requestId,
                    priority_level: level,
                    reason: level === 'red' ? 'Employee marked as emergency' : 'Employee marked as priority'
                });
                
                if (response.success) {
                    const levelLabel = level === 'red' ? 'Emergency' : 'Priority';
                    UI.showToast(`âœ… ${levelLabel} badge set successfully!`, 'success');
                    
                    // Reload data
                    await loadLeaves();
                } else {
                    UI.showToast('âŒ ' + (response.error || 'Failed to set priority'), 'error');
                }
            } catch (error) {
                UI.showToast('âŒ Failed to set priority badge', 'error');
                console.error('Priority set error:', error);
            }
        }

        function renderLeaves() {
            const container = document.getElementById('leavesContainer');

            const filtered = currentFilter === 'all'
                ? allLeaves
                : allLeaves.filter(l => l.status.toLowerCase() === currentFilter);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i data-lucide="file-text"></i>
                        </div>
                        <div class="empty-title">No ${currentFilter === 'all' ? '' : currentFilter + ' '}leave requests found</div>
                        <div class="empty-desc">Start by creating a new request from the dashboard</div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const html = filtered.map((leave, idx) => {
                const start = new Date(leave.start_date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const end = new Date(leave.end_date).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const dateStr = start === end ? start : `${start} â†’ ${end}`;

                const submitted = new Date(leave.created_at).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Determine display status - AI approved vs HR approved
                let displayStatus = leave.status;
                let statusClass = leave.status.toLowerCase();
                const statusLower = leave.status.toLowerCase();
                
                if (statusLower === 'approved') {
                    if (leave.approved_by && leave.approved_by.startsWith('HR:')) {
                        displayStatus = 'Approved';
                    } else {
                        displayStatus = 'AI Approved';
                        statusClass = 'ai-approved';
                    }
                } else if (statusLower === 'rejected') {
                    displayStatus = leave.approved_by && leave.approved_by.startsWith('HR:') ? 'Rejected' : 'AI Rejected';
                } else {
                    displayStatus = 'Pending';
                }

                const iconName = statusLower === 'pending' ? 'clock' : statusLower === 'approved' ? 'check-circle' : 'x-circle';
                
                // Check if eligible for priority badge
                const priorityUI = statusLower === 'pending' ? getPriorityUI(leave) : '';
                const hasPriorityEligible = priorityEligibility[leave.request_id]?.can_set_priority;

                return `
                    <div class="leave-card hover-lift ${hasPriorityEligible ? 'priority-eligible' : ''}" style="animation-delay: ${idx * 0.05}s;">
                        <div class="leave-icon animate-float">
                            <i data-lucide="${iconName}"></i>
                        </div>
                        <div class="leave-details">
                            <div class="leave-type">${leave.leave_type}</div>
                            <div class="leave-dates">
                                <i data-lucide="calendar"></i>
                                ${dateStr}
                            </div>
                            ${leave.reason ? `<div class="leave-reason">${leave.reason}</div>` : ''}
                            ${priorityUI}
                        </div>
                        <div class="leave-meta">
                            <span class="status-badge ${statusClass}">${displayStatus}</span>
                            <div class="leave-submitted">
                                <i data-lucide="clock" style="width: 14px; height: 14px; display: inline; vertical-align: middle;"></i>
                                ${submitted}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
            lucide.createIcons();
        }

        function filterLeaves(filter) {
            currentFilter = filter;

            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            renderLeaves();
        }

        document.getElementById('logoutBtn').onclick = () => {
            localStorage.clear();
            window.location.href = '../../index.html';
        };

        init();
    </script>
</body>

</html>